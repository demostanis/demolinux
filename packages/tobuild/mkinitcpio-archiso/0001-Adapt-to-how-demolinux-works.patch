From 719edad7e6528ef434b8841dbc80e6bef18c7277 Mon Sep 17 00:00:00 2001
From: demostanis worlds <demostanis@protonmail.com>
Date: Thu, 21 Sep 2023 21:12:30 +0200
Subject: [PATCH] Adapt to how demolinux works

---
 hooks/archiso   | 65 +++++++++++++++++++++++++++++++++++++------------
 install/archiso |  3 +++
 2 files changed, 53 insertions(+), 15 deletions(-)

diff --git a/hooks/archiso b/hooks/archiso
index d2c600e..b3711f2 100644
--- a/hooks/archiso
+++ b/hooks/archiso
@@ -45,13 +45,13 @@ _mnt_dmsnapshot() {
 
 # args: source, newroot, mountpoint
 _mnt_overlayfs() {
-    local src="${1}"
-    local newroot="${2}"
-    local mnt="${3}"
-    mkdir -p "/run/archiso/cowspace/${cow_directory}/upperdir" "/run/archiso/cowspace/${cow_directory}/workdir"
+    local lowerdir="${1##lowerdir=}"
+    local upperdir="${2##upperdir=}"
+    local workdir="${3##workdir=}"
+    local mountpoint="${4##mountpoint=}"
     mount -t overlay -o \
-        "lowerdir=${src},upperdir=/run/archiso/cowspace/${cow_directory}/upperdir,workdir=/run/archiso/cowspace/${cow_directory}/workdir" \
-        airootfs "${newroot}${mnt}"
+        "lowerdir=${lowerdir},upperdir=${upperdir},workdir=${workdir}" \
+        airootfs "${mountpoint}"
 }
 
 # args: /path/to/image_file, mountpoint
@@ -211,20 +211,53 @@ archiso_mount_handler() {
     local sigfile cms_sigfile fs_img fs_img_size iso_blockdev
 
     if ! mountpoint -q "/run/archiso/bootmnt"; then
-        _mnt_dev "${archisodevice}" "/run/archiso/bootmnt" "-r" "defaults"
+        _mnt_dev /dev/disk/by-partlabel/boot "/run/archiso/bootmnt" "-r" "defaults"
     fi
 
+    btrfs_root=/run/archiso/btrfs
+    _mnt_dev /dev/disk/by-partlabel/system $btrfs_root "-r" "subvol=system,compress=zstd"
     # We need this block at the top for early failure
     # but also to be able to give the fs_img to CMS verification.
     # (sha512sum files contain the image, CMS files does not)
-    if [ -f "/run/archiso/bootmnt/${archisobasedir}/${arch}/airootfs.sfs" ]; then
-        fs_img="/run/archiso/bootmnt/${archisobasedir}/${arch}/airootfs.sfs"
-    elif [ -f "/run/archiso/bootmnt/${archisobasedir}/${arch}/airootfs.erofs" ]; then
-        fs_img="/run/archiso/bootmnt/${archisobasedir}/${arch}/airootfs.erofs"
+    if [ -e "$btrfs_root/airootfs.sfs" ]; then
+        fs_img="$btrfsroot/airootfs.sfs"
+    elif [ -e "$btrfs_root/airootfs.erofs" ]; then
+        fs_img="$btrfs_root/airootfs.erofs"
     else
         echo "ERROR: no root file system image found"
         launch_interactive_shell
     fi
+    if [ $(( $(btrfs subvol list $btrfs_root | wc -l) < 4 )) = 1 ]; then
+        # first, resize the filesystem
+        umount -f $btrfs_root
+        # i wonder why i do all this work when
+        # i could just hardcode everything...
+        device="$(readlink /dev/disk/by-partlabel/system)"
+        part="${device##*/}"
+        disk="${part%%?}"
+        partid="${part##"$disk"}"
+        parted -sf "/dev/$disk" resizepart $partid 100%
+        partprobe
+
+        _mnt_dev /dev/disk/by-partlabel/system $btrfs_root "-w" "subvol=system,compress=zstd"
+        btrfs filesystem resize max $btrfs_root
+
+        # finally, create the necessary subvolumes
+        btrfs subvol create $btrfs_root/persistfs
+        btrfs subvol create $btrfs_root/data
+        mkdir $btrfs_root/data/programming
+        mkdir $btrfs_root/data/downloads
+        mkdir $btrfs_root/data/music
+        chown 1000:1000 -R $btrfs_root/data
+        btrfs subvol create $btrfs_root/swap
+        btrfs filesystem mkswapfile --size 4G --uuid clear $btrfs_root/swap/swapfile 2>/dev/null
+
+        umount -f $btrfs_root
+        _mnt_dev /dev/disk/by-partlabel/system $btrfs_root "-r" "subvol=system,compress=zstd"
+    fi
+
+    _mnt_dev /dev/disk/by-partlabel/system /run/archiso/persistfs "-w" "subvol=/system/persistfs,compress=zstd,noatime"
+    _mnt_dev /dev/disk/by-partlabel/system /run/archiso/data "-w" "subvol=/system/data,compress=zstd,noatime"
 
     # shellcheck disable=SC2154
     # defined via initcpio's parse_cmdline()
@@ -292,7 +325,7 @@ archiso_mount_handler() {
     # * the root file system image size is less than 4 GiB,
     # * the estimated available memory is more than the root file system image size + 2 GiB.
     if [ "${copytoram}" = "auto" ]; then
-        iso_blockdev="$(realpath "$(resolve_device "$archisodevice")")"
+        iso_blockdev="$(realpath "$(resolve_device /dev/disk/by-partlabel/system)")"
         if [ "$iso_blockdev" = "${iso_blockdev##/dev/sr}" ]; then
             fs_img_size="$(du -bsk "$fs_img" | cut -f 1)"
             if [ "$fs_img_size" -lt 4194304 ] && [ "$(awk '$1 == "MemAvailable:" { print $2 }' /proc/meminfo)" -gt $((fs_img_size + 2097152)) ]; then
@@ -314,14 +347,20 @@ archiso_mount_handler() {
         msg ":: Mounting /run/archiso/cowspace (tmpfs) filesystem, size=${cow_spacesize}..."
         mount --mkdir -t tmpfs -o "size=${cow_spacesize}",mode=0755 cowspace /run/archiso/cowspace
     fi
-    mkdir -p "/run/archiso/cowspace/${cow_directory}"
-    chmod 0700 "/run/archiso/cowspace/${cow_directory}"
 
     _mnt_fs "${fs_img}" "/run/archiso/airootfs"
     if [ -f "/run/archiso/airootfs/airootfs.img" ]; then
         _mnt_dmsnapshot "/run/archiso/airootfs/airootfs.img" "${newroot}" "/"
     else
-        _mnt_overlayfs "/run/archiso/airootfs" "${newroot}" "/"
+        # why doesnt {cowspace,persistfs} work...
+        mkdir -p /run/archiso/cowspace/upperdir
+        mkdir -p /run/archiso/cowspace/workdir
+        mkdir -p /run/archiso/persistfs/upperdir
+        mkdir -p /run/archiso/persistfs/workdir
+        mkdir -p /run/archiso/cowspace/lowerdir
+
+        _mnt_overlayfs lowerdir=/run/archiso/airootfs upperdir=/run/archiso/persistfs/upperdir workdir=/run/archiso/persistfs/workdir mountpoint=/run/archiso/cowspace/lowerdir
+        _mnt_overlayfs lowerdir=/run/archiso/cowspace/lowerdir upperdir=/run/archiso/cowspace/upperdir workdir=/run/archiso/cowspace/workdir mountpoint="$newroot/"
     fi
 
     if [ "${copytoram}" = "y" ]; then
--- a/install/archiso
+++ b/install/archiso
@@ -7,6 +7,7 @@ build() {
     add_module "loop"
     add_module "dm-snapshot"
     add_module "overlay"
+    add_module "btrfs"
 
     add_runscript
 
@@ -14,6 +15,8 @@ build() {
     add_binary dmsetup
     add_binary losetup
     add_binary openssl
+    add_binary btrfs
+    add_binary parted
 
     if command -v pv >/dev/null 2>&1; then
         add_binary pv
-- 
2.42.0

